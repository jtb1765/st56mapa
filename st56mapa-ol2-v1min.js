!function(a,e,t,r,s){e.behaviors.st56mapa={attach:function(t,r){a(".jmapas-map",t).once("jmapas-map",function(){OpenLayers.Events.includeXY=!0;var s=r.st56mapa.map_datos,o=r.st56mapa.map_settings,n=r.st56mapa.map_id;s.olcapasseleccionables=[],s.olcapasfeatureinfo=[],s.olcontrolpanel=[],s.olfooterwrapper=[],s.olcolumnsidebarwrapper=[];var l=r.st56mapa.map_name,p={projection:new OpenLayers.Projection(o.map_projection),units:o.units,maxExtent:new OpenLayers.Bounds(o.extent.xmin,o.extent.ymin,o.extent.xmax,o.extent.ymax),restrictedExtent:new OpenLayers.Bounds(o.restrict.xmin,o.restrict.ymin,o.restrict.xmax,o.restrict.ymax),maxResolution:"auto",numZoomLevels:o.numzoomlevels,displayProjection:new OpenLayers.Projection(o.display_projection),fractionalZoom:!1,controls:[]},i=new OpenLayers.Map(n,p),c=e.st56mapa.addLayers(i,s,l),m=o.center,u=new OpenLayers.Geometry.Point(m.lon,m.lat);m.srs!=o.map_projection&&u.transform(new OpenLayers.Projection(m.srs),i.projection);var d=new GeoExt.MapPanel({title:"Mapa temático de "+r.st56mapa.map_name,region:"center",map:i,center:new OpenLayers.LonLat(u.x,u.y),zoom:m.zoom,cls:"jtbgxmappanel"}),y=new GeoExt.LegendPanel({autoScroll:!0,region:"east",collapsible:!0,collapseMode:"mini",width:200,autoScroll:!0,border:!0,title:"Leyenda",split:!0,cls:"jtbgxleyenda",filter:function(e){return-1==a.inArray(e.getLayer().clase,["wms","wmscomodatos","marcas"])}});a(this).data("st56mapa",{map:i,datos:s,settings:o,map_panel:d,ol_capas:c,map_name:l}),e.attachBehaviors(this),e.st56mapa.addControls(t,i,s,o);var f=new Ext.tree.TreePanel({title:"Capas",border:!0,region:"west",split:!0,collapsible:!0,collapseMode:"mini",autoScroll:!0,width:200,root:e.st56mapa.addLayerSwitcher(t,i,s,o,d),rootVisible:!1,lines:!1,cls:"jtbgxlistasimplecapas"}),b=new Ext.Window({renderTo:"map_element",layout:"fit",hideBorders:!0,width:1165,height:756,closable:!1,maximizable:!0,resizable:!1,items:{layout:"border",deferredRender:!1,items:[f,d,y]},tbar:[]}).show();b.getTopToolbar().addClass("jtbgxtoolbartable"),jQuery.each(s.olcontrolpanel,function(a,e){b.getTopToolbar().addButton(e)})})}},e.theme.prototype.refcat=function(a){var e="";return e+="<span class='detalles_atributo'>Referencia catastral:&nbsp</span><br />",e+="<span class='detalles_valor'>"+a+"</span><br />"},e.theme.prototype.coordinates=function(a){var e="";return e+="<span class='detalles_atributo'>Coordenadas ETRS89:&nbsp</span><br />",e+="<span class='detalles_valor'> ("+a.lon+" , "+a.lat+")</span><br />"},e.theme.prototype.detalles=function(t,r){var s="";return a.each(r,function(a,r){var o=t[a];"Null"!=o&&null!=o&&void 0!=o&&1==r.visible&&("IMG"==r.tipo?(s+="<br />",s+='<img src="'+o+'" style="width:220px"/><br />'):"PDF"==r.tipo?(s+='<span class="file">',s+='<a href="'+o+'" target="_blank" type="application/pdf">',s+=r.descripcion+"</a>",s+="</span><br />"):"HREF"==r.tipo?(s+='<a href="'+o+'" target="_blank">',s+=r.descripcion,s+="</a><br />"):"TXT"==r.tipo?(s+="<span class='detalles_atributo'>"+r.descripcion+"</span>",s+="<span class='detalles_valor'>"+o+"</span><br />"):"REAL"==r.tipo?(o=e.st56mapa.formato_numero(o,2,",","."),s+="<span class='detalles_atributo'>"+r.descripcion+"</span>",s+="<span class='detalles_valor'>"+o+"</span><br />"):"INT"==r.tipo&&(o=e.st56mapa.formato_numero(o,0,",","."),s+="<span class='detalles_atributo'>"+r.descripcion+"</span>",s+="<span class='detalles_valor'>"+o+"</span><br />"))}),s},e.theme.prototype.medida=function(a,e,t){var r="";return r+=1==t?"Longitud: "+a.toFixed(2)+" "+e:"Superficie: "+a.toFixed(2)+" "+e+"<sup>2</sup>"},e.theme.prototype.detallesRefCat=function(a){var e="<br />";return"1"==a.cucoor?(e+="<span class='detalles_atributo'>Referencia catastral:&nbsp</span><br />",e+="<span class='detalles_valor'>"+a.refcat+"</span><br />",e+="<span class='detalles_atributo'>Detalle:&nbsp</span><br />",e+="<span class='detalles_valor'>"+a.refdes+"</span><br />"):"1"==a.cuerr&&(e+="<span class='detalles_atributo'>Error:&nbsp</span><br />",e+="<span class='detalles_valor'>"+a.errcod+"</span><br />",e+="<span class='detalles_atributo'>Descripción:&nbsp</span><br />",e+="<span class='detalles_valor'>"+a.errdes+"</span><br />"),e+="<br />"},e.theme.prototype.featureinfo=function(t,r){var s="";if(0==t.length)s+="Sin información <br />";else if(r)a.each(t,function(a,t){s+="<span class='detalles_atributo'>"+a+"</span><br />",s+=e.theme.prototype.detalles(t,r),s+="<br />"});else{var o=/^(ht|f)tp(s?)\:\/\/[0-9a-zA-Z]/,n=/(zip)$/;a.each(t,function(e,t){s+="<span class='detalles_atributo'>"+e+"</span><br />",a.each(t,function(a,e){-1!=e.search(o)?(s+='<a href="'+e+'" target="_blank">',-1!=e.search(n)?s+="Descargar ":s+="Ir a ",s+=a,s+="</a><br />"):(s+="<span class='detalles_atributo'>"+a+":</span>&nbsp",s+="<span class='detalles_valor'>"+e+"</span><br />")}),s+="<br />"})}return s},e.theme.prototype.error=function(a){var e="<br />";return e+="<span class='detalles_capa'>Error:&nbsp</span><br />",e+="<span class='error'>"+a+"</span><br />"},e.st56mapa={addLayers:function(a,t,r){var s,o=[],n=t.capabase;jQuery.each(n,function(n,l){(s=e.st56mapa.layers[l.tipo](a,t,l,r)).clase=l.tipo,a.addLayer(s),o.push(s)});var l=t.capadatos;return jQuery.each(l,function(n,l){s=e.st56mapa.layers[l.tipo](a,t,l,r),a.addLayer(s),s.group=l.grupo,s.idname=l.idname,s.clase=l.tipo,o.push(s)}),o},on_select_elemento:function(a){var t=a.feature,r="",s="";if("Marcadores"!=t.layer.name){r="Detalles";var o=e.settings.st56mapa.map_datos.atributos[t.layer.idname];s='<br /><span class="detalles_capa">'+t.layer.name+"</span><br />",s+=e.theme.prototype.detalles(t.attributes,o)}else r=t.popuptitle,s=t.popuphtml;var n=new GeoExt.Popup({title:r,width:234,html:s,anchored:!1,maximizable:!0,collapsibe:!0,unpinnable:!0,map:t.layer.map,popupCls:"olPopup"});e.st56mapa.compruebaAlturaPopup(n,500),t.popup=n},on_unselect_elemento:function(a){var e=a.feature;e.renderIntent="default",e.popup&&(e.popup.destroy(),e.popup=null)},compruebaAlturaPopup:function(a,e){a.show(),a.getHeight()>e&&(a.setHeight(e),a.setAutoScroll(!0)),a.doLayout(),a.show()},addLayerSwitcher:function(a,e,t,r,s){var o=[];return o=new GeoExt.tree.LayerContainer({text:"all capas",layerStore:s.layers,leaf:!1,expanded:!0}),t.olcolumnsidebarwrapper.push(o),o},addControls:function(a,e,t,r){},handleMeasurements:function(a,t){var r=a.units,s=a.order,o=a.measure;new GeoExt.Popup({title:"Medición",width:234,html:e.theme.prototype.medida(o,r,s),anchored:!1,maximizable:!0,collapsibe:!0,unpinnable:!0,map:t,popupCls:"olPopup"}).show()},borrarMedidas:function(){console.log("desactivando control")},formato_numero:function(a,e,t,r){if(a=parseFloat(a),isNaN(a))return"";if(void 0!==e&&(a=a.toFixed(e)),a=a.toString().replace(".",void 0!==t?t:","),r)for(var s=new RegExp("(-?[0-9]+)([0-9]{3})");s.test(a);)a=a.replace(s,"$1"+r+"$2");return a},imprimir:function(){t.print()},buscarparcelaporrefcat:function(){Ext.Msg.prompt("Referencia catastral","Escriba referencia catastral",function(t,r){"ok"==t&&a.ajax({type:"POST",url:"buscar_parcela_por_refcat",dataType:"json",success:function(t){if("0"==t.cuerr){var r=t,s=a("#map_element").data("st56mapa").map,o=a("#map_element").data("st56mapa").settings,n=new OpenLayers.Geometry.Point(r.X,r.Y);if(r.SRS!=o.map_projection&&n.transform(new OpenLayers.Projection(r.SRS),s.projection),n.x<o.extent.xmin||n.x>o.extent.xmax||n.y<o.extent.ymin||n.y>o.extent.ymax)alert("Parece que la parcela está fuera de los límites del mapa");else{var l=s.zoom,p=new OpenLayers.LonLat(n.x,n.y);s.setCenter(p,l);var i=e.theme.prototype.refcat(r.RC);e.st56mapa.dibujaMarcador(s,p,i,"blue","Referencia catastral")}}else alert(t.errcod+" "+t.errdes)},data:{js:"123456",refcat:r}})})},referenciacatastral:function(t){var r=a("#map_element").data("st56mapa").map;OpenLayers.Element.addClass(r.viewPortDiv,"olCursorWait");var s=r.getLonLatFromPixel(t.xy),o=e.st56mapa.dibujaMarcador(r,s,"Consultando al catastro...","blue","Referencia castastral");a.ajax({type:"POST",url:"detalles_refcat",dataType:"json",success:function(a){var t=e.theme.prototype.detallesRefCat(a);e.st56mapa.actualizaMarcador(a.featureid,t,!0)},data:{js:"123456",srs:r.projection.projCode,x:s.lon,y:s.lat,id:o}}),OpenLayers.Element.removeClass(r.viewPortDiv,"olCursorWait")},interseccion_capas_vectoriales:function(t,r,s,o){var n="";a.each(t.layers,function(t,r){if(r instanceof OpenLayers.Layer.Vector&&r.visibility&&"Marcadores"!=r.name){n+='<br /><span class="detalles_capa">'+r.group+":&nbsp"+r.name+"</span><br />";var s=!1;a.each(r.features,function(a,t){if(o.intersects(t.geometry)){var l=e.settings.st56mapa.map_datos.atributos[r.idname];n+=e.theme.prototype.detalles(t.attributes,l),s=!0}return!s}),s||(n+='<span class="detalles_valor">No hay intersección</span><br />')}}),e.st56mapa.actualizaMarcador(s,n,!0)},interseccion_capas_wms:function(t,r,s,o,n){var l=[];if(a.each(t.layers,function(a,e){e instanceof OpenLayers.Layer.WMS&&e.getVisibility()&&!e.isBaseLayer&&l.push(e)}),0==l.length){return e.st56mapa.actualizaMarcador(s,"<br />No hay capas de datos externas visibles<br />",n),void OpenLayers.Element.removeClass(t.viewPortDiv,"olCursorWait")}var p=t.getExtent();a.each(l,function(l,i){return a.ajax({url:"before_get_feature_info",type:"POST",data:{SERVICE:i.params.SERVICE,VERSION:i.params.VERSION,REQUEST:"GetFeatureInfo",LAYERS:i.params.LAYERS,QUERY_LAYERS:i.params.LAYERS,URL:i.url,STYLES:i.params.STYLES,BBOX:p.left+", "+p.bottom+", "+p.right+", "+p.top,FEATURE_COUNT:"10",HEIGHT:t.size.h,WIDTH:t.size.w,FORMAT:i.params.FORMAT,INFO_FORMAT:"application/vnd.esri.wms_featureinfo_xml",SRS:i.params.SRS,X:r.xy.x,Y:r.xy.y,PUNTOID:s,NOMBRE:i.name,SOBREESCRIBIR:n,CAPAIDNAME:i.idname,GRUPO:i.group},success:function(a){e.settings.st56mapa.map_datos.atributos[a.capaidname];var t="<br /><span class='detalles_capa'>"+a.grupo+":&nbsp"+a.nombre+"</span><br />";t+=e.theme.prototype.featureinfo(a.featureinfo,null),e.st56mapa.actualizaMarcador(a.puntoid,t,a.sobreescribir)},dataType:"json"}),o})},ficha:function(t){var r=a("#map_element").data("st56mapa").map;OpenLayers.Element.addClass(r.viewPortDiv,"olCursorWait");var s=r.getLonLatFromPixel(t.xy),o=e.st56mapa.dibujaMarcador(r,s,"Calculando ficha...","green","Ficha"),n=new OpenLayers.Geometry.Point(s.lon,s.lat);e.st56mapa.interseccion_capas_vectoriales(r,s,o,n);e.st56mapa.interseccion_capas_wms(r,t,o,!0,0),OpenLayers.Element.removeClass(r.viewPortDiv,"olCursorWait");var l=r.getLayersByName("Marcadores")[0].getFeatureById(o);e.st56mapa.compruebaAlturaPopup(l.popup,500)},crearNota:function(e){var t=a("#map_element").data("st56mapa").map,r=a("#map_element").data("st56mapa").map_name,s=t.getLonLatFromPixel(e.xy),o=new OpenLayers.Geometry.Point(s.lon,s.lat),n=t.getLayersByName("Notas")[0];Ext.MessageBox.buttonText={ok:"Vale",yes:"Modificar",no:"Eliminar",cancel:"Cancelar"},Ext.Msg.show({title:"Añadir nota",msg:"Escriba una nota",buttons:Ext.Msg.OKCANCEL,fn:function(a,e){if("ok"==a){var t=new OpenLayers.Feature.Vector(o,{nota:e});n.addFeatures([t]);var s=(new OpenLayers.Format.GeoJSON).write(n.features);localStorage.setItem(r,s)}},multiline:!0,width:300,defaultTextHeight:150,value:"",cls:"jtbgxnota"})},on_select_nota:function(e){var t=e.feature,r=a("#map_element").data("st56mapa").map,s=a("#map_element").data("st56mapa").map_name,o=r.getLayersByName("Notas")[0];Ext.MessageBox.buttonText={ok:"OK",yes:"Modificar",no:"Eliminar",cancel:"Cancelar"},Ext.MessageBox.show({title:"Modificar/Eliminar nota",msg:"Puede utilizar etiquetas html para dar formato al texto",buttons:Ext.Msg.YESNOCANCEL,fn:function(a,e){if("yes"==a){t.attributes.nota=e;r=(new OpenLayers.Format.GeoJSON).write(o.features);localStorage.setItem(s,r)}else if("no"==a){o.removeFeatures([t]),o.destroyFeatures([t]),o.redraw();var r=(new OpenLayers.Format.GeoJSON).write(o.features);localStorage.setItem(s,r)}},multiline:!0,width:300,defaultTextHeight:150,value:t.attributes.nota,cls:"jtbgxnota"})},on_unselect_nota:function(a){a.feature.renderIntent="default"},pointCoordinates:function(t){var r=a("#map_element").data("st56mapa").map,s=r.getLonLatFromPixel(t.xy),o=e.theme.prototype.coordinates(s);e.st56mapa.dibujaMarcador(r,s,o,"gold","Coordenadas")},cambiarsrs:function(){var e=a("#map_element").data("st56mapa").map;a.each(e.layers,function(t,r){r instanceof OpenLayers.Layer.Vector&&r.visibility&&"Marcadores"!=r.name&&a.each(r.features,function(t,r){var s=r.data.HREF,o=r.geometry.x,n=r.geometry.y,l=new OpenLayers.Geometry.Point(o,n);l.transform(e.projection,e.displayProjection),a.ajax({type:"POST",url:"cambiar_srs",dataType:"json",success:function(a){console.log("Actualizado "+a.nodoid)},data:{js:"123456",nodoid:s,x:l.x,y:l.y}})})})},limpiarMarcadores:function(){var e=a("#map_element").data("st56mapa").map;OpenLayers.Element.addClass(e.viewPortDiv,"olCursorWait");var t=e.getLayersByName("Marcadores")[0];a.each(t.features,function(a,e){e.popup&&e.popup.destroy()}),t.removeAllFeatures(),t.destroyFeatures(),OpenLayers.Element.removeClass(e.viewPortDiv,"olCursorWait")},dibujaMarcador:function(a,t,r,s,o){var n=new OpenLayers.Geometry.Point(t.lon,t.lat),l=new OpenLayers.Feature.Vector(n,{color:s,title:o}),p=a.getLayersByName("Marcadores")[0];if(p){var i=new GeoExt.Popup({title:o,width:234,maximizable:!0,collapsible:!0,map:a,anchored:!0,location:l,html:r,unpinnable:!1,popupCls:"olPopup"});p.addFeatures(l),e.st56mapa.compruebaAlturaPopup(i,500),l.popuptitle=o,l.popuphtml=r,l.popup=i}return l.id},actualizaMarcador:function(t,r,s){var o=a("#map_element").data("st56mapa").map,n=o.getLayersByName("Marcadores")[0].getFeatureById(t);if(1==s){n.popup.destroy();var l=new GeoExt.Popup({title:n.popuptitle,width:234,maximizable:!0,collapsible:!0,map:o,anchored:!0,location:n,html:r,unpinnable:!1,popupCls:"olPopup"});n.popuphtml=r,n.popup=l}else n.popuphtml+=r,n.popup.add({xtype:"box",autoEl:{html:r}});e.st56mapa.compruebaAlturaPopup(n.popup,500)},controlTransparenciaCapas:function(){var e=a("#map_element").data("st56mapa").map,t=a("#jtbopacidadcapas"),r=a("#jtbopacidadcapas tbody tr");r.removeClass("element-invisible"),a.each(r,function(t,r){var s=r.id,o=e.getLayersBy("idname",s)[0],n=-1;n="wmscomodatos"==o.clase?2:0==o.styleMap.styles.default.rules.length?0:1,1==o.getVisibility()?(a("#slider-"+s).slider({range:"min",max:100,min:0,step:1,value:2==n?100*o.opacity:0==n?100*o.styleMap.styles.default.defaultStyle.fillOpacity:100*o.styleMap.styles.default.rules[0].symbolizer.fillOpacity,slide:function(e,t){a("#valor-"+s).val(t.value),2==n?o.opacity=t.value/100:1==n?o.styleMap.styles.default.rules[0].symbolizer.fillOpacity=t.value/100:o.styleMap.styles.default.defaultStyle.fillOpacity=t.value/100},stop:function(e,t){1==n&&a.each(o.styleMap.styles.default.rules,function(a,e){e.symbolizer.fillOpacity=t.value/100}),o.redraw()}}),a("#valor-"+s).val(a("#slider-"+s).slider("value"))):a("#"+r.id).addClass("element-invisible")}),t.dialog({autoOpen:!1,minHeight:200,maxHeight:700,minWidth:200,maxWidth:500,resizable:!1,title:"Opacidad de datos visibles",beforeClose:function(a,e){t.toggleClass("element-invisible")}}),t.dialog("isOpen")||(t.dialog("open"),t.toggleClass("element-invisible"))}},e.st56mapa.layers={}}(jQuery,Drupal,this,this.document);